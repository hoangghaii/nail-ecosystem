# ==========================================
# NGINX SERVER CONFIGURATION
# ==========================================
# Routes requests to appropriate backend services:
#   - / → nail-client (customer website)
#   - /admin → nail-admin (admin dashboard)
#   - /api → nail-api (backend API)
# ==========================================

# Upstream backend services
upstream nail_client_backend {
    server nail-client:80;
}

upstream nail_admin_backend {
    server nail-admin:81;
}

upstream nail_api_backend {
    server nail-api:3000;
}

# Main server block
server {
    listen 80;
    server_name _;

    # Health check endpoint for nginx itself
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }

    # ==========================================
    # API Routes (/api/*)
    # ==========================================
    location /api {
        # Remove /api prefix when forwarding to backend
        rewrite ^/api/(.*) /$1 break;

        proxy_pass http://nail_api_backend;
        proxy_http_version 1.1;

        # Headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $server_name;

        # WebSocket support (if needed)
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;

        # Buffering
        proxy_buffering off;
        proxy_request_buffering off;
    }

    # ==========================================
    # Admin Dashboard Routes (/admin/*)
    # ==========================================
    location /admin {
        # Remove /admin prefix when forwarding
        rewrite ^/admin/(.*) /$1 break;
        rewrite ^/admin$ / break;

        proxy_pass http://nail_admin_backend;
        proxy_http_version 1.1;

        # Headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Timeouts
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }

    # Serve admin static assets directly
    location ~ ^/admin/(assets|static)/ {
        rewrite ^/admin/(.*) /$1 break;
        proxy_pass http://nail_admin_backend;
        proxy_http_version 1.1;

        # Cache static assets
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # ==========================================
    # Client Website Routes (/)
    # ==========================================
    location / {
        proxy_pass http://nail_client_backend;
        proxy_http_version 1.1;

        # Headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Timeouts
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }

    # Serve client static assets with caching
    location ~ ^/(assets|static)/ {
        proxy_pass http://nail_client_backend;
        proxy_http_version 1.1;

        # Cache static assets
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # ==========================================
    # Error Pages
    # ==========================================
    error_page 404 /404.html;
    error_page 500 502 503 504 /50x.html;
}
