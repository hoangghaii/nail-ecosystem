# ==========================================
# Production Environment Configuration
# ==========================================
# Usage: docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d
# ==========================================

services:
  client:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
      # Enable BuildKit for faster builds
      cache_from:
        - nail-client:prod-cache
      args:
        - BUILDKIT_INLINE_CACHE=1

    image: nail-client:${VERSION:-latest}

    container_name: nail-client-prod
    hostname: nail-client-prod-host

    restart: always

    ports:
      - "80:80"

    environment:
      - NODE_ENV=production

    # Resource limits to prevent container from consuming all resources
    deploy:
      replicas: 1
      resources:
        limits:
          cpus: '0.50'
          memory: 256M
        reservations:
          cpus: '0.25'
          memory: 128M
      restart_policy:
        condition: on-failure
        max_attempts: 3
        delay: 5s
        window: 120s

    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        compress: "true"

    networks:
      - nail-network

    # Health check already defined in base docker-compose.yml
    # This ensures nginx is serving content properly

    labels:
      com.nail.service: "client"
      com.nail.environment: "production"
      com.nail.description: "Pink Nail Salon Website - Production"
      com.nail.version: "${VERSION:-latest}"

networks:
  nail-network:
    driver: bridge
    name: nail-network-prod
    labels:
      com.nail.network: "production"
