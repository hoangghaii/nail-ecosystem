# ==========================================
# Docker Compose - Production
# ==========================================
# Usage: docker compose -f docker-compose.prod.yml up -d

services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
      target: production  # Use production stage (nginx)

    container_name: nail-admin-prod

    image: nail-admin:prod

    restart: always

    ports:
      - "8081:81"  # Map to host port 8081

    # NO VOLUMES for code (code is immutable in image!)
    # Only add volumes for data persistence if needed in future

    env_file:
      - .env.production

    environment:
      - NODE_ENV=production

    # Resource limits (prevent container from consuming too much)
    deploy:
      resources:
        limits:
          cpus: '1.0'       # Max 1 CPU core
          memory: 512M      # Max 512MB RAM

        reservations:
          cpus: '0.25'      # Reserve 25% of 1 core
          memory: 128M      # Reserve 128MB RAM

    # Health check (from Dockerfile HEALTHCHECK)
    # Container marked unhealthy if /health endpoint fails
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:81/health"]
      interval: 30s       # Check every 30 seconds
      timeout: 3s         # Timeout after 3 seconds
      retries: 3          # Mark unhealthy after 3 failures
      start_period: 10s   # Grace period for container startup

    # Logging with rotation (prevent disk fill)
    logging:
      driver: "json-file"
      options:
        max-size: "10m"   # Max 10MB per log file
        max-file: "3"     # Keep 3 files (total 30MB max)

    # Security options
    security_opt:
      - no-new-privileges:true  # Prevent privilege escalation

    # Note: read_only filesystem + tmpfs requires nginx subdirectory setup
    # Commented out for simplicity - can be enabled with proper Dockerfile modifications
    # read_only: true
    # tmpfs:
    #   - /var/cache/nginx:rw,noexec,nosuid,size=50m
    #   - /var/run:rw,noexec,nosuid,size=10m
    #   - /tmp:rw,noexec,nosuid,size=10m

    networks:
      - nail-admin-prod

# Production network
networks:
  nail-admin-prod:
    driver: bridge
    name: nail-admin-production
