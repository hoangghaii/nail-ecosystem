# Phase 02 — pnpm Workspace Setup

**Parent plan**: [plan.md](./plan.md)
**Depends on**: [phase-01-analysis-and-prep.md](./phase-01-analysis-and-prep.md)

---

## Overview

- **Date**: 2026-02-20
- **Priority**: High
- **Status**: pending
- **Description**: Replace npm workspace config with pnpm equivalents, update all package.json files, generate `pnpm-lock.yaml`.

---

## Key Insights

- pnpm workspace config lives in `pnpm-workspace.yaml` (not `package.json`)
- `"workspaces"` field in root `package.json` must be removed (pnpm ignores it; keeping it causes confusion)
- All `"*"` version specs for `@repo/*` deps become `"workspace:*"` — pnpm resolves these to local packages
- `turbo.json` requires no changes — Turborepo 2.3 auto-detects package manager
- Root `package.json` scripts stay identical (`turbo dev`, `turbo build`, etc.) — pnpm runs them the same way

---

## Requirements

- pnpm 10.30.0 installed via corepack
- Phase 01 analysis complete

---

## Related Code Files

| File | Action |
|------|--------|
| `/Users/hainguyen/Documents/nail-project/pnpm-workspace.yaml` | create |
| `/Users/hainguyen/Documents/nail-project/.npmrc` | create |
| `/Users/hainguyen/Documents/nail-project/package.json` | modify |
| `/Users/hainguyen/Documents/nail-project/.gitignore` | modify |
| `/Users/hainguyen/Documents/nail-project/apps/client/package.json` | modify |
| `/Users/hainguyen/Documents/nail-project/apps/admin/package.json` | modify |
| `/Users/hainguyen/Documents/nail-project/apps/api/package.json` | modify |
| `/Users/hainguyen/Documents/nail-project/packages/types/package.json` | modify |
| `/Users/hainguyen/Documents/nail-project/packages/utils/package.json` | modify |
| `/Users/hainguyen/Documents/nail-project/pnpm-lock.yaml` | generated by `pnpm install` |
| `/Users/hainguyen/Documents/nail-project/package-lock.json` | delete |
| `/Users/hainguyen/Documents/nail-project/apps/client/package-lock.json` | delete |
| `/Users/hainguyen/Documents/nail-project/apps/admin/package-lock.json` | delete |
| `/Users/hainguyen/Documents/nail-project/apps/api/package-lock.json` | delete |

---

## Implementation Steps

### Step 1 — Enable corepack and install pnpm

```bash
corepack enable
corepack use pnpm@10.30.0
# Verify:
pnpm --version  # should output 10.30.0
```

### Step 2 — Create `pnpm-workspace.yaml`

Create `/Users/hainguyen/Documents/nail-project/pnpm-workspace.yaml`:

```yaml
packages:
  - 'apps/*'
  - 'packages/*'
  - 'tooling/*'
```

Mirrors the existing `"workspaces"` array in root `package.json`.

### Step 3 — Create `.npmrc`

Create `/Users/hainguyen/Documents/nail-project/.npmrc`:

```ini
# Hoist packages for Turborepo + ESLint config resolution compatibility
public-hoist-pattern[]=*

# Keep isolation (do NOT shamefully-hoist)
shamefully-hoist=false

# Use hoisted node-linker for tool compatibility (NestJS CLI, Vite, etc.)
node-linker=hoisted
```

### Step 4 — Update root `package.json`

**Remove** the `"workspaces"` field entirely.
**Update** `"packageManager"` field.
**Update** `"engines"` field.

Full updated root `package.json`:

```json
{
  "name": "pink-nail-salon",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "turbo dev",
    "build": "turbo build",
    "lint": "turbo lint",
    "type-check": "turbo type-check",
    "clean": "turbo clean",
    "format": "prettier --write \"**/*.{ts,tsx,md,json}\""
  },
  "devDependencies": {
    "@tanstack/react-query-devtools": "^5.91.2",
    "prettier": "^3.7.3",
    "turbo": "^2.3.0"
  },
  "engines": {
    "node": ">=20.0.0",
    "pnpm": ">=10.0.0"
  },
  "packageManager": "pnpm@10.30.0"
}
```

### Step 5 — Update `apps/client/package.json`

Replace all `"@repo/*": "*"` with `"@repo/*": "workspace:*"`:

In `"dependencies"`:
```json
"@repo/types": "workspace:*",
"@repo/utils": "workspace:*",
```

In `"devDependencies"`:
```json
"@repo/eslint-config": "workspace:*",
"@repo/prettier-config": "workspace:*",
"@repo/tailwind-config": "workspace:*",
"@repo/typescript-config": "workspace:*",
```

### Step 6 — Update `apps/admin/package.json`

Same pattern as client. Replace all 6 `@repo/*` deps:

In `"dependencies"`:
```json
"@repo/types": "workspace:*",
"@repo/utils": "workspace:*",
```

In `"devDependencies"`:
```json
"@repo/eslint-config": "workspace:*",
"@repo/prettier-config": "workspace:*",
"@repo/tailwind-config": "workspace:*",
"@repo/typescript-config": "workspace:*",
```

### Step 7 — Update `apps/api/package.json`

Replace 3 `@repo/*` deps:

In `"dependencies"`:
```json
"@repo/types": "workspace:*",
```

In `"devDependencies"`:
```json
"@repo/eslint-config": "workspace:*",
"@repo/prettier-config": "workspace:*",
"@repo/typescript-config": "workspace:*",
```

### Step 8 — Update `packages/types/package.json`

In `"devDependencies"`:
```json
"@repo/typescript-config": "workspace:*",
```

### Step 9 — Update `packages/utils/package.json`

In `"devDependencies"`:
```json
"@repo/typescript-config": "workspace:*",
```

### Step 10 — Update `.gitignore`

**Current state** (problematic lines):
```
!package-lock.json    # explicitly un-ignores package-lock.json (keep it tracked)
pnpm-lock.yaml        # ignores pnpm lockfile (wrong — we WANT it tracked)
```

**Required changes**:
- Remove line `!package-lock.json` (no longer needed — we're deleting it)
- Remove line `pnpm-lock.yaml` (we want pnpm-lock.yaml committed to git)
- Add line `package-lock.json` (explicitly ignore if accidentally generated)

Updated relevant section of `.gitignore`:
```gitignore
# Logs
logs
*.log
npm-debug.log*
yarn-debug.log*
yarn-error.log*
pnpm-debug.log*
lerna-debug.log*

node_modules
dist
dist-ssr
*.local

# Lock files from other package managers (ignore if accidentally generated)
package-lock.json
yarn.lock
```

### Step 11 — Delete package-lock.json files

```bash
rm /Users/hainguyen/Documents/nail-project/package-lock.json
rm /Users/hainguyen/Documents/nail-project/apps/client/package-lock.json
rm /Users/hainguyen/Documents/nail-project/apps/admin/package-lock.json
rm /Users/hainguyen/Documents/nail-project/apps/api/package-lock.json
```

### Step 12 — Remove existing node_modules

```bash
rm -rf /Users/hainguyen/Documents/nail-project/node_modules
rm -rf /Users/hainguyen/Documents/nail-project/apps/client/node_modules
rm -rf /Users/hainguyen/Documents/nail-project/apps/admin/node_modules
rm -rf /Users/hainguyen/Documents/nail-project/apps/api/node_modules
rm -rf /Users/hainguyen/Documents/nail-project/packages/types/node_modules
rm -rf /Users/hainguyen/Documents/nail-project/packages/utils/node_modules
```

### Step 13 — Run pnpm install

```bash
cd /Users/hainguyen/Documents/nail-project
pnpm install
```

This generates `pnpm-lock.yaml` at root. Verify:
- No errors in output
- `pnpm-lock.yaml` created
- `node_modules/.modules.yaml` exists (pnpm metadata)

### Step 14 — turbo.json verification

No changes needed. Turborepo 2.3 detects pnpm via `packageManager` field in root `package.json`.

Verify Turborepo still works:
```bash
pnpm run build
pnpm run type-check
```

---

## Todo Checklist

- [ ] corepack enabled, pnpm 10.30.0 installed
- [ ] `pnpm-workspace.yaml` created
- [ ] `.npmrc` created with correct settings
- [ ] Root `package.json` updated (workspaces removed, packageManager updated, engines updated)
- [ ] `apps/client/package.json` — 6 `@repo/*` deps updated to `workspace:*`
- [ ] `apps/admin/package.json` — 6 `@repo/*` deps updated to `workspace:*`
- [ ] `apps/api/package.json` — 4 `@repo/*` deps updated to `workspace:*`
- [ ] `packages/types/package.json` — 1 dep updated
- [ ] `packages/utils/package.json` — 1 dep updated
- [ ] `.gitignore` updated (remove `!package-lock.json` and `pnpm-lock.yaml` exclusion)
- [ ] All 4 `package-lock.json` files deleted
- [ ] All `node_modules` directories removed
- [ ] `pnpm install` runs without errors
- [ ] `pnpm-lock.yaml` committed to git
- [ ] `pnpm run build` succeeds
- [ ] `pnpm run type-check` succeeds

---

## Success Criteria

- `pnpm install` completes without errors
- `pnpm-lock.yaml` generated at root
- `pnpm run type-check` passes all apps
- `pnpm run build` produces correct output (7s or similar)
- No `node_modules` in per-app directories (pnpm hoists to root with `node-linker=hoisted`)

---

## Risk Assessment

| Risk | Likelihood | Mitigation |
|------|-----------|------------|
| `workspace:*` not resolving local packages | Low | Confirmed pnpm behavior; `pnpm-workspace.yaml` globs match all package paths |
| husky `prepare` not firing on `pnpm install` | Medium | pnpm v9+ supports `prepare` lifecycle; if `.husky/` dir is already committed, no problem |
| Peer dependency warnings flooding output | Medium | Normal with pnpm's stricter peer resolution; add `auto-install-peers=true` to `.npmrc` if needed |
| `public-hoist-pattern[]=*` too permissive | Low | Acceptable trade-off for Turborepo monorepo; documents intent |

---

## Next Steps

Proceed to [phase-03-dockerfile-and-docker-compose.md](./phase-03-dockerfile-and-docker-compose.md)
